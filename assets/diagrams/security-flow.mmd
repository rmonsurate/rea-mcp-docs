%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#a484fb', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#a484fb', 'secondaryColor': '#22c55a', 'lineColor': '#a484fb', 'textColor': '#f8fafc', 'actorBkg': '#a484fb', 'actorBorder': '#a484fb', 'actorTextColor': '#ffffff', 'actorLineColor': '#a484fb', 'signalColor': '#a484fb', 'signalTextColor': '#f8fafc', 'labelBoxBkgColor': '#0f172a', 'labelBoxBorderColor': '#a484fb', 'labelTextColor': '#f8fafc', 'loopTextColor': '#f8fafc', 'noteBorderColor': '#22c55a', 'noteBkgColor': '#14532d', 'noteTextColor': '#ffffff', 'activationBorderColor': '#a484fb', 'activationBkgColor': '#1e293b', 'sequenceNumberColor': '#ffffff'}}}%%
sequenceDiagram
    participant U as User
    participant R as Rea Platform
    participant V as Vault/Secrets
    participant M as MCP Client
    participant S as MCP Server
    participant A as External API

    rect rgba(164, 132, 251, 0.15)
        Note over U,A: Configuration Phase
        U->>R: Configure Notion Integration
        R->>V: Store API Token (encrypted)
        V-->>R: Token ID
        R-->>U: Integration configured
    end

    rect rgba(34, 197, 94, 0.15)
        Note over U,A: Runtime Authentication
        U->>R: Request using Notion
        R->>V: Retrieve token
        V-->>R: Decrypted token
        R->>M: Initialize with token
        M->>S: Start server with env
        S-->>M: Server ready
    end

    rect rgba(164, 132, 251, 0.15)
        Note over U,A: Secure Tool Execution
        R->>M: tools/call with context
        M->>S: JSON-RPC request
        S->>S: Validate request
        S->>A: API call with token
        A-->>S: Response
        S->>S: Sanitize response
        S-->>M: Safe result
        M-->>R: Tool result
    end

    rect rgba(220, 38, 38, 0.2)
        Note over U,A: Human-in-the-Loop
        R->>U: Confirm destructive action?
        U-->>R: Approved
        R->>M: Execute with confirmation
    end
