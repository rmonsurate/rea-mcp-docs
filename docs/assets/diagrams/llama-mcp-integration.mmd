%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#a484fb', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#a484fb', 'secondaryColor': '#22c55a', 'secondaryTextColor': '#ffffff', 'tertiaryColor': '#1e293b', 'lineColor': '#a484fb', 'textColor': '#f8fafc', 'mainBkg': '#0f172a', 'nodeBorder': '#a484fb', 'clusterBkg': '#020817', 'clusterBorder': '#a484fb', 'nodeTextColor': '#ffffff'}}}%%
flowchart TB
    subgraph User["User Interface"]
        Chat["Chat Input"]
        Response["AI Response"]
    end

    subgraph ReaAgent["Rea Agent Layer"]
        McpAgent["MCP-Aware Agent"]

        subgraph Reflection["Reflection Framework"]
            Understand["1. Understand"]
            Plan["2. Plan"]
            Execute["3. Execute"]
            Verify["4. Verify"]
            Reflect["5. Reflect"]
        end

        PromptBuilder["Reflection Prompt Builder"]
    end

    subgraph LLaMA["LLaMA Engine"]
        SystemPrompt["System Prompt<br>+ Tool Definitions"]
        ToolCalling["Tool Calling Logic"]
        Completion["Text Completion"]
    end

    subgraph MCPHost["MCP Host"]
        ClientPool["Client Pool"]
        ToolRegistry["Tool Registry"]

        subgraph Clients["Connected Servers"]
            Notion["Notion"]
            Slack["Slack"]
            GitHub["GitHub"]
            Custom["Custom"]
        end
    end

    Chat --> McpAgent
    McpAgent --> PromptBuilder
    PromptBuilder --> Understand
    Understand --> Plan
    Plan --> Execute
    Execute --> Verify
    Verify --> Reflect
    Reflect --> PromptBuilder

    PromptBuilder --> SystemPrompt
    SystemPrompt --> LLaMA

    McpAgent --> ToolRegistry
    ToolRegistry --> ClientPool
    ClientPool --> Clients

    ToolCalling --> ClientPool
    Clients --> ToolCalling
    ToolCalling --> Completion
    Completion --> Response
